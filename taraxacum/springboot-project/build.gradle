plugins {
    /*id 'org.springframework.boot' version '2.3.1.RELEASE'*/
    /*id 'org.springframework.boot' version '1.5.22.RELEASE'*/
    id 'org.springframework.boot' version '2.2.2.RELEASE'
    id 'io.spring.dependency-management' version '1.0.9.RELEASE'
}

configurations {
    developmentOnly
    runtimeClasspath {
        extendsFrom developmentOnly
    }
    compileOnly {
        extendsFrom annotationProcessor
    }
}

dependencies {
    /* spring boot */
    implementation 'org.springframework.boot:spring-boot-starter'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-aop'
    /*implementation 'org.springframework.boot:spring-boot-starter-security'*/
    /* spring boot 2.x 采用的是 Hikari 数据库连接池 */
    implementation 'org.springframework.boot:spring-boot-starter-jdbc'
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    /* spring boot caching 支持 */
    implementation 'org.springframework.boot:spring-boot-starter-cache'
    /* 添加 Thymeleaf 依赖 */
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'

    /* 在设置 compiler 中勾选 Make Project automatically,
    在 Shift+Ctrl+Alt+/ 选择 Registry - compiler.automake.allow.when.app.running */

    /* caching */
    implementation 'net.sf.ehcache:ehcache'

    /* mybatis spring boot dependencies */
    /* v2.0.1 需要 springboot v2.0.9， v1.3.4 需要 springboot v1.5.20 */
    implementation 'org.mybatis.spring.boot:mybatis-spring-boot-starter:1.3.4'

    /* database libs */
    implementation 'com.alibaba:druid-spring-boot-starter:1.1.16'
    implementation 'mysql:mysql-connector-java:8.0.15'
    implementation 'com.alibaba:druid:1.1.16'
    implementation 'com.zaxxer:HikariCP:3.4.1'
    implementation 'com.mchange:c3p0:0.9.5.4'
    implementation 'org.apache.commons:commons-dbcp2:2.6.0'

    /* jwt */
    implementation 'com.auth0:java-jwt:3.10.3'
    implementation 'io.jsonwebtoken:jjwt:0.9.1'

    /* json */
    implementation 'com.alibaba:fastjson:1.2.54'
    /* 这个会合默认的 springboot 自带版本冲突 */
    /*implementation 'com.fasterxml.jackson.core:jackson-databind:2.10.1'*/
    // implementation 'com.google.code.gson:gson:2.8.5'
    // implementation 'org.json:json:20180813'

    /* common util */
    implementation 'org.apache.commons:commons-lang3:3.9'
    implementation 'commons-io:commons-io:2.6'
    implementation 'commons-fileupload:commons-fileupload:1.3.3'

    compileOnly 'org.projectlombok:lombok'
    /* 打包时要使用,不然 getter/setter 不能使用 */
    annotationProcessor 'org.projectlombok:lombok'
    /* 在类上 @ConfigurationProperties(prefix = "bean.properties")
    *  @EnableConfigurationProperties({类.class})，
    *  绑定注入的属性
    * */
    annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'

    testImplementation('org.springframework.boot:spring-boot-starter-test') {
        exclude group: 'org.junit.vintage', module: 'junit-vintage-engine'
    }
}

test {
    useJUnitPlatform()
}

jar {
    excludes = ["*.jar"]
    dependsOn clearJar
    dependsOn copyJar

    manifestContentCharset 'UTF-8'
    metadataCharset 'UTF-8'

    manifest {
        attributes("Main-Class": "cn.nihility.boot.SpringbootProjectApplication")
        attributes("branchName": "$branchName")
        attributes("commitId": "$branchCommitId")
        attributes('Implementation-Title': 'Project Gradle Quickstart')
    }

    /* 这个不可以放到 allprojects 当中，不然会出现 class 重复，应该放到每个独立的 project 当中 */
    /* 可执行 jar 包，所有依赖的 jar 包单独放到 lib 目录下 */
    if (!configurations.runtimeClasspath.isEmpty()) {
        manifest.attributes('Class-Path': '. ' + configurations.runtimeClasspath.files.collect { /*println it.name;*/ "lib/$it.name" }.join(' '))
    }

}


bootJar {
    excludes = ["*.jar"]
    dependsOn clearJar
    dependsOn copyJar

    manifest {
        attributes ("branchName": "$branchName")
        attributes ("commitId": "$branchCommitId")
        attributes("Main-Class": "org.springframework.boot.loader.PropertiesLauncher")
    }

    if (!configurations.runtimeClasspath.isEmpty()) {
        manifest.attributes('Class-Path': '. ' + configurations.runtimeClasspath.files.collect { /*println it.name;*/ "lib/$it.name" }.join(' '))
    }
}